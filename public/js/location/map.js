(()=>{var t,e,n,a,o,i,s,l,c,d,r,p,u,f,h,m,v,g,w,x,b,k,y,C,D=100,z=!1,j=!1,S=!1,T=!0;function _(){var o=a.width();if(!o||0===o)return setTimeout(_,500),!1;1===e.length&&($("#point-location-submit").on("click",(function(a){n.val()&&(e.append('<div class="point admin" style="top:'+s+"px;left:"+i+'px"><input type="hidden" name="map_point[]" value="'+i+"-"+s+"-"+n.val()+'" /></div>'),t.modal("toggle"))})),I()),$.ajaxSetup({headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")}}),function(){1===u.length&&($("#draggable-map").draggable({drag:function(){z=!0},stop:function(){setTimeout((function(){z=!1}),200)}}),u.mousemove((function(t){var e=g.offset();m=t.pageX-e.left,v=t.pageY-e.top})));1===l.length&&(l.on("click",(function(t){t.preventDefault(),E(25)})),c.on("click",(function(t){t.preventDefault(),E(-25)})),d.on("click",(function(t){t.preventDefault(),D=100,E(0)})),p.on("click",(function(t){t.preventDefault(),O(!1)})),r.on("click",(function(t){t.preventDefault(),O(!0)})))}(),I(),k.click((function(t){$(this).hide(),S=!0,y.show(),g.addClass("map-admin-mode"),$.each($(".point"),(function(t){$(this).draggable({disabled:!1})})),F()})),y.click((function(t){$(this).hide(),S=!1,k.show(),g.removeClass("map-admin-mode"),R()})),$.each($(".point"),(function(t){X($(this))})),R(),a.click((function(t){if(!1!==S&&!0!==j&&!0!==z){N();var e=$(this).offset();i=t.pageX-e.left-25,s=t.pageY-e.top-25,i<0&&(i=0),s<0&&(s=0);var n=D/100;s=parseInt(s)/n,i=parseInt(i)/n,$.ajax({url:$(this).data("url")+"?axis_y="+parseInt(s)+"&axis_x="+parseInt(i)}).done((function(t,e,n){t&&(h.hide(),f.html(t).show(),Y())})).fail((function(t,e,n){console.log("map point error",t)}))}})),$(a).bind("wheel",(function(t){!0===t.ctrlKey&&(t.preventDefault(),t.originalEvent.deltaY>0?E(-10):E(10))})),function(){var t=a.width();$(".loading-map").hide();a.height();var e=g.width(),n=(g.height(),e/t);D=Math.floor(100*n),E(0)}(),$(".map-point-legend").click((function(t){$($(this).attr("href")).click()}))}function E(t){o||(o=a.width());var e=D+t;if(e>300||e<10)return!1;c.removeAttr("disabled"),l.removeAttr("disabled");var n=(D=e)/100;a.width(o*n),t>0?0:0,$.each($(".point"),(function(){A($(this),n)})),D<=10?c.attr("disabled","disabled"):e>=300&&l.attr("disabled","disabled");var i=u.position();t>0?u.css("left",i.left-m/g.width()*100).css("top",i.top-v/g.height()*100):t<0&&u.css("left",i.left+m/g.width()*100).css("top",i.top+v/g.height()*100)}function I(){$.each($(".point"),(function(t){$(this).unbind("click"),$(this).on("click",(function(t){t.preventDefault(),!0!==j&&function(t){if(!0===z||!0===j)return;T&&(C.fadeOut(),T=!1);if(S)return N(),void $.ajax({url:t.data("url-modal")}).done((function(t,e,n){t&&(h.hide(),f.html(t).show(),Y())})).fail((function(t,e,n){console.log("map point error",t)}));w.hasClass("hidden")&&(w.removeClass("hidden"),$("#location-map-main").removeClass("col-md-12").addClass("col-md-9 col-sm-8"));b.show(),x.html(""),$(".point-focus").removeClass("point-focus"),t.addClass("point-focus"),$.ajax(t.data("url-show")).done((function(t){b.hide(),x.html(t),$(".entity-close").on("click",(function(t){F()}))}))}($(this))}))}))}function O(t){t?(p.show(),r.hide(),$.each($(".map .point"),(function(){$(this).show()}))):(p.hide(),r.show(),$.each($(".map .point"),(function(){$(this).hide()})))}function F(){w.addClass("hidden"),$("#location-map-main").removeClass("col-md-9 col-sm-8").addClass("col-md-12")}function N(){h.show(),f.html(""),t.modal()}function R(){$.each($(".point"),(function(t){$(this).draggable({disabled:!0})}))}function X(t){t.draggable({revert:!1,start:function(t,e){j=!0,$(t.target).addClass("point-moving")},stop:function(t,e){var n=$(t.target);n.removeClass("point-moving"),i=e.position.left,s=e.position.top;var a=D/100;return i/=a,s/=a,data={axis_x:i,axis_y:s},console.log("url move",n.data("url-move")),$.post(n.data("url-move"),data).done((function(t,e,n){})).fail((function(t,e,n){})),setTimeout((function(){j=!1}),50),!0}})}function Y(){window.initForeignSelect(),$(document).on("click",".map-point-delete",(function(e){var n=$(this).attr("href");return e.preventDefault(),f.hide(),h.show(),$.post({url:n,dataType:"json",data:{_method:"DELETE"},context:this}).done((function(e,n,a){e.id&&$("#"+e.id).remove(),t.modal("hide")})),!1})),function(){$(".select2-icon").select2({templateResult:J,templateSelection:J,language:$(this).data("language")}),$(".spectrum").spectrum({preferredFormat:"hex",showInput:!0,showPalette:!0,allowEmpty:!0}),$(".select2-shape").select2({templateResult:K,templateSelection:K,language:$(this).data("language")})}();var e=$(".phase-first"),n=$(".phase-second"),a=$(".point-save"),o=$(".point-entity"),i=$(".point-label");$("#phase-first-entity").on("click",(function(t){t.preventDefault(),o.show(),e.hide(),n.show(),a.show()})),$("#phase-first-label").on("click",(function(t){t.preventDefault(),i.show(),e.hide(),n.show(),a.show()})),$(".phase-undo").on("click",(function(t){t.preventDefault(),n.hide(),a.hide(),o.hide(),i.hide(),e.show()})),$(".map-point-form").submit((function(e){var n=$(this).serialize();$.ajax({type:$(this).attr("method"),url:$(this).attr("action"),data:n,dataType:"json",encode:!0}).done((function(e){if(t.modal("hide"),e.point){var n=$("#"+e.id);1===n.length&&n.remove(),$(".map-container").append(e.point),I();var a=$("#"+e.id);X(a),A(a,D/100),a.tooltip()}})).fail((function(t){console.log("fail",t),t.responseJSON.errors&&$(".location-map-errors").html(function(t){var e="";for(var n in t)t.hasOwnProperty(n)&&(e+=t[n]+"<br>");return e}(t.responseJSON.errors)).fadeIn()})),e.preventDefault()})),$('[data-toggle="popover"]').popover({html:!0})}function A(t,e){t.css("top",t.data("top")*e+"px"),t.css("left",t.data("left")*e+"px"),t.css("width",t.data("size")*e+"px"),t.css("height",t.data("size")*e+"px");var n=24;10===t.data("size")?n=5:25===t.data("size")?n=12:100===t.data("size")?n=56:200===t.data("size")&&(n=108),t.css("font-size",n*e+"px")}function J(t){if(!t.id)return t.text;var e=$(t.element);if(!e)return t.text;var n=e.data("icon");if(n){if("entity"===n)return t.text;n.includes(" ")||(n="ra ra-"+n)}else n="ra ra-"+t.id;return $('<span><i class="'+n+'"></i> '+t.text+"</span>")}function K(t){return"none"===t.id?t.text:$('<span><i class="fa-solid fa-'+t.id+'"></i> '+t.text+"</span>")}$(document).ready((function(){e=$("#location-map-admin"),w=$("#location-map-panel"),x=$("#location-map-panel-target"),b=$("#location-map-panel-loading"),t=$("#point-location"),n=$("#location_id"),a=$("#location-map-image"),l=$("#map-zoom-in"),c=$("#map-zoom-out"),d=$("#map-zoom-reset"),p=$("#map-toggle-hide"),r=$("#map-toggle-show"),f=$("#map-point-body"),h=$(".modal-loading"),u=$("#draggable-map"),k=$("#map-admin-mode"),y=$("#map-view-mode"),g=$(".map"),C=$(".map-helper"),_()}))})();